<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</title>

<link rel="stylesheet" href="style.css">
<script src="data/data_config.js"></script>

<style>
.container{ max-width:1000px; margin:20px auto; }
.role-select{ margin-bottom:20px; padding:10px; border-radius:6px; border:1px solid var(--blue-royal); background-color:#2a2a2a; color:#fff; }
.cards-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:25px; }
.assistant-card{ background-color:#2a2a2a; border-radius:10px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:1px solid var(--blue-royal); position:relative; transition:transform 0.3s,border-color 0.3s; }
.assistant-card:hover{ transform:translateY(-5px); border-color:var(--gold); }
.card-header{ display:flex; align-items:center; margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; }
.profile-img{ width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-left:15px; }
.card-header h3{ color:var(--gold); margin:0; font-size:1.4em; }
.card-details p{ margin:8px 0; text-align:right; font-size:0.95em; color:#ccc; }
.card-details strong{ color:var(--white); }
.rating{ color:var(--yellow-warning); font-size:1.1em; margin-top:5px; }
.btn-delete{ margin-top:10px; padding:10px 16px; border:none; border-radius:6px; background-color:var(--red-emergency); color:#fff; cursor:pointer; font-size:1.1em; }
#commentsModal{ display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#commentsModal .modal-content{ background-color:#2a2a2a; padding:20px; border-radius:10px; max-width:500px; width:90%; max-height:70%; overflow-y:auto; }
.comment-item{ margin-bottom:10px; border-bottom:1px dashed #555; padding-bottom:5px; display:flex; justify-content:space-between; align-items:center; }
.comment-name{ font-weight:bold; color:var(--gold); display:block; }
.comment-stars{ color:var(--yellow-warning); display:block; margin:2px 0; }
.comment-text{ display:block; color:#ccc; margin-top:2px; }
.close-modal{ float:right; cursor:pointer; font-size:1.2em; color:#fff; }
</style>
</head>

<body>

<div class="header-controls">
    <a href="main_services.html" class="btn-back">ğŸ”™ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<div class="container">
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</h1>

    <select id="roleSelect" class="role-select">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† --</option>
        <option value="GUIDE">Ù…Ø±Ø´Ø¯ÙŠÙ†</option>
        <option value="COMPANION">Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
        <option value="DRIVER">Ø³Ø§Ø¦Ù‚ÙŠÙ†</option>
    </select>

    <div id="assistantCardsGrid" class="cards-grid"></div>
</div>

<div id="commentsModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeCommentsModal()">âœ–</span>
        <div id="modalCommentsList"></div>
    </div>
</div>

<script>
const KEYS = window.KEYS;
const ROLES = window.ROLES;

function loadAppData(){ return window.loadData(); }
function saveKey(key, value){ return window.saveDataToStorage(key, value); }

const roleSelect = document.getElementById('roleSelect');
const modal = document.getElementById('commentsModal');
const modalCommentsList = document.getElementById('modalCommentsList');

roleSelect.addEventListener('change', () => { renderAssistants(roleSelect.value); });

function getMajorityRating(comments){
    if(!comments || comments.length===0) return 5;
    const counts = {};
    comments.forEach(c => counts[c.rating] = (counts[c.rating]||0) + 1);
    let max = 0, major = 5;
    for(const r in counts){ if(counts[r] > max){ max = counts[r]; major = parseInt(r); } }
    return major;
}

function renderAssistants(roleKey){
    const grid = document.getElementById('assistantCardsGrid');
    grid.innerHTML = '';
    if(!roleKey) return;

    const data = loadAppData();
    const keyMap = {
        "GUIDE": KEYS.ASSISTANTS_GUIDES,
        "COMPANION": KEYS.ASSISTANTS_COMPANIONS,
        "DRIVER": KEYS.ASSISTANTS_DRIVERS
    };
    const dataKey = keyMap[roleKey];
    const assistants = data[dataKey] || [];

    if(assistants.length === 0){
        grid.innerHTML = '<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.</p>';
        return;
    }

    assistants.forEach(a=>{
        const comments = (data[KEYS.COMMENTS] && data[KEYS.COMMENTS].assistants && data[KEYS.COMMENTS].assistants[a.chatCode]) ? data[KEYS.COMMENTS].assistants[a.chatCode] : [];
        const majorityRating = getMajorityRating(comments);
        const stars = 'â­'.repeat(majorityRating) + 'â˜†'.repeat(5-majorityRating);

        let details = '';
        if(a.groupLimit){
            details += `<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.guideType}</p>`;
            details += `<p><strong>Ø­Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${a.groupLimit} Ø´Ø®Øµ</p>`;
            details += `<p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.price} Ø¯Ø±Ù‡Ù…</p>`;
        } else if(a.specialization){
            details += `<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.specialization}</p>`;
            details += `<p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.priceDay} Ø¯Ø±Ù‡Ù…</p>`;
            details += `<p><strong>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©:</strong> ${a.priceHour} Ø¯Ø±Ù‡Ù…</p>`;
        } else if(a.cityPrice){
            details += `<p><strong>Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.cityPrice} Ø¯Ø±Ù‡Ù…</p>`;
            details += `<p><strong>Ø£Ø¬Ø±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.outCityPrice} Ø¯Ø±Ù‡Ù…</p>`;
        }

        const card = document.createElement('div');
        card.className = 'assistant-card';
        card.innerHTML = `
            <div class="card-header">
                <img src="${a.img || 'images/placeholder_profile.png'}" class="profile-img" alt="${a.name}">
                <div>
                    <h3>${a.name}</h3>
                    <div class="rating">${stars} (${a.experience} Ø³Ù†ÙˆØ§Øª)</div>
                </div>
            </div>

            <div class="card-details">${details}
                <p><strong>Ù†Ø¨Ø°Ø©:</strong> ${a.about}</p>
            </div>

            <button class="btn-delete" onclick="deleteAssistant('${roleKey}','${a.chatCode}')">Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
            <button class="btn-delete" onclick="openCommentsModal('${a.chatCode}')">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
        `;
        grid.appendChild(card);
    });
}

function deleteAssistant(roleKey, chatCode){
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ØŸ')) return;

    const data = loadAppData();
    const keyMap = {
        "GUIDE": KEYS.ASSISTANTS_GUIDES,
        "COMPANION": KEYS.ASSISTANTS_COMPANIONS,
        "DRIVER": KEYS.ASSISTANTS_DRIVERS
    };
    const dataKey = keyMap[roleKey];
    const list = data[dataKey] || [];
    const idx = list.findIndex(a => a.chatCode === chatCode);

    if(idx !== -1){
        list.splice(idx, 1);
        window.saveDataToStorage(dataKey, list);
    }

    const chats = data[KEYS.CHATS] || {};
    if(chats[chatCode]){
        delete chats[chatCode];
        window.saveDataToStorage(KEYS.CHATS, chats);
    }

    const commentsStore = data[KEYS.COMMENTS] || {};
    if(commentsStore.assistants && commentsStore.assistants[chatCode]){
        delete commentsStore.assistants[chatCode];
        window.saveDataToStorage(KEYS.COMMENTS, commentsStore);
    }

    renderAssistants(roleKey);
}

function openCommentsModal(chatCode){
    modalCommentsList.innerHTML = '';

    const data = loadAppData();
    const comments = (data[KEYS.COMMENTS] && data[KEYS.COMMENTS].assistants && data[KEYS.COMMENTS].assistants[chatCode]) ? data[KEYS.COMMENTS].assistants[chatCode] : [];

    if(comments.length === 0){
        modalCommentsList.innerHTML = '<p style="color:#aaa; text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
    } else {
        comments.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = 'comment-item';

            div.innerHTML = `
                <span>
                    <span class="comment-name">${c.name}</span>
                    <span class="comment-stars">${'â­'.repeat(c.rating)}</span>
                    <span class="comment-text">${c.text}</span>
                </span>
            `;

            const delBtn = document.createElement('button');
            delBtn.textContent = "ğŸ—‘ï¸";
            delBtn.style.background = "var(--red-emergency)";
            delBtn.style.border = "none";
            delBtn.style.color = "#fff";
            delBtn.style.padding = "6px 10px";
            delBtn.style.borderRadius = "6px";
            delBtn.style.cursor = "pointer";

            delBtn.onclick = () => {
                if(!confirm('Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ')) return;

                const fresh = loadAppData();
                const freshCommentsStore = fresh[KEYS.COMMENTS] || {};
                if(!freshCommentsStore.assistants) freshCommentsStore.assistants = {};
                const arr = freshCommentsStore.assistants[chatCode] || [];
                if(i >= 0 && i < arr.length){
                    arr.splice(i, 1);
                    freshCommentsStore.assistants[chatCode] = arr;
                    window.saveDataToStorage(KEYS.COMMENTS, freshCommentsStore);
                }
                openCommentsModal(chatCode);
            };

            div.appendChild(delBtn);
            modalCommentsList.appendChild(div);
        });
    }

    modal.style.display = 'flex';
}

function closeCommentsModal(){
    modal.style.display = 'none';
}
</script>

</body>
</html>
